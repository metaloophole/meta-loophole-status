name: Check Loophole Status

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

jobs:
  check_loophole:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests python-telegram-bot

      - name: Run Loophole Bot
        env:
          BOT_TOKEN: 7588713286:AAHF_S7ZxD62YI3JDoPtdnvroiOWbA-M2CQ
          CHAT_ID: -1002814683347
        run: |
          python3 <<EOF
          import requests, os
          from telegram import Bot

          bot = Bot(token=os.environ['BOT_TOKEN'])
          chat_id = os.environ['CHAT_ID']

          base = "https://raw.githubusercontent.com/metaloophole/meta-loophole-status/main"
          
          # Fetch JSON
          try:
              data = requests.get(f"{base}/status.json").json()
          except:
              exit()

          if data.get("loophole_active") and data.get("region", "").lower() == "usa":
              msg = "âš ï¸ *Loophole ACTIVE!*\nGo change PFP now ðŸ˜ˆ"

              # Add Method
              method = requests.get(f"{base}/method.txt")
              if method.status_code == 200:
                  msg += f"\n\nðŸ“„ *Method:*\n`{method.text.strip()}`"

              bot.send_message(chat_id=chat_id, text=msg, parse_mode="Markdown")

              # Add Proof if exists
              proof = requests.get(f"{base}/proof.jpg")
              if proof.status_code == 200:
                  with open("proof.jpg", "wb") as f:
                      f.write(proof.content)
                  with open("proof.jpg", "rb") as photo:
                      bot.send_photo(chat_id=chat_id, photo=photo)
          EOF
