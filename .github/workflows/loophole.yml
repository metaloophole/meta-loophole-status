name: Check Loophole Status

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check_loophole:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests python-telegram-bot

      - name: Run Loophole Bot
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python3 <<EOF
          import requests, os
          from telegram import Bot
          
          bot = Bot(token=os.environ['BOT_TOKEN'])
          chat_id = os.environ['CHAT_ID']
          
          headers = {'Authorization': f"token {os.environ['GH_PAT']}"}
          repo_url = "https://raw.githubusercontent.com/metaloophole/meta-loophole-status/main"
          
          status = requests.get(f"{repo_url}/status.json").json()
          
          if status.get("loophole_active") == True and status.get("region", "").lower() == "usa":
              message = "âš ï¸ Loophole ACTIVE! Go change PFP now ðŸ˜ˆ"

              # Send method if exists
              method = requests.get(f"{repo_url}/method.txt")
              if method.status_code == 200:
                  message += f"\n\nðŸ“„ *Method:*\n{method.text}"

              bot.send_message(chat_id=chat_id, text=message, parse_mode="Markdown")

              # Send proof image if available
              proof = requests.get(f"{repo_url}/proof.jpg")
              if proof.status_code == 200:
                  with open("proof.jpg", "wb") as f:
                      f.write(proof.content)
                  bot.send_photo(chat_id=chat_id, photo=open("proof.jpg", "rb"))
          EOF
