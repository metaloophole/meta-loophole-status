name: Check Loophole Status

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check_loophole:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests python-telegram-bot

      - name: Run Loophole Bot
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "üîç Running Loophole Check Script..."
          python3 <<EOF
import requests, os
from telegram import Bot
from telegram.error import TelegramError

# Init bot
bot_token = os.environ.get("BOT_TOKEN")
chat_id = os.environ.get("CHAT_ID")
bot = Bot(token=bot_token)

print(f"üîë BOT_TOKEN: {bot_token[:10]}...")  # partial for debug
print(f"üì¢ CHAT_ID: {chat_id}")

repo_url = "https://raw.githubusercontent.com/metaloophole/meta-loophole-status/main"

def notify(text):
    try:
        print("üì§ Sending Telegram message...")
        bot.send_message(chat_id=chat_id, text=f"ü™© Loophole Bot:\n{text}", parse_mode="Markdown")
        print("‚úÖ Message sent.")
    except TelegramError as e:
        print(f"‚ùå Telegram Error: {e}")
    except Exception as e:
        print(f"‚ùå Other Error: {e}")

try:
    response = requests.get(f"{repo_url}/status.json")
    print(f"üåê status.json HTTP {response.status_code}")
    status = response.json()
    print(f"üì¶ Status Loaded: {status}")
except Exception as e:
    notify(f"*Failed to load status.json:* `{e}`")
    raise SystemExit()

if status.get("loophole_active") == True and status.get("region", "").lower() == "usa":
    message = "‚ö†Ô∏è *Loophole ACTIVE for USA!*\nChange your PFP now üòà"
    method_url = f"{repo_url}/method.txt"

    method_req = requests.get(method_url)
    print(f"üìÑ method.txt HTTP {method_req.status_code}")
    if method_req.status_code == 200 and method_req.text.strip():
        message += f"\n\nüìÑ *Method:*\n`{method_req.text.strip()}`"

    notify(message)
else:
    print("‚ÑπÔ∏è Loophole not active or not for USA.")
EOF
